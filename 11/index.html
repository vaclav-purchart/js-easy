<!doctype html>
<html lang="en">

<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width,initial-scale=1" />
	<title>Isometric Tilemap â€” Camera + Zoom</title>
	<style>
		body {
			margin: 0;
			display: flex;
			height: 100vh;
			background: #1d1d1f;
			color: #eee;
			font-family: system-ui
		}

		#ui {
			width: 200px;
			padding: 16px;
			background: #111;
			overflow: auto;
			box-shadow: 2px 0 8px rgba(0, 0, 0, .4)
		}

		#canvas-wrap {
			flex: 1;
			display: flex;
			align-items: center;
			justify-content: center;
			overflow: hidden
		}

		canvas {
			background: #0a3;
			border: 1px solid #000;
			image-rendering: pixelated;
		}

		label {
			display: block;
			margin-top: 12px;
			font-size: 13px;
			color: #9aa
		}

		textarea,
		input {
			width: 100%;
			background: #0a0a0a;
			color: #dfe;
			border: 1px solid #222;
			padding: 6px;
			margin-top: 4px
		}

		button {
			margin-top: 6px;
			padding: 8px 10px;
			border: 0;
			border-radius: 6px;
			background: #0b84ff;
			color: #fff;
			cursor: pointer
		}
	</style>
</head>

<body>
	<div id="ui">
		<h2>Camera + Zoom</h2>

		<label>Zoom (1 = default):</label>
		<input id="zoom" type="number" min="1" max="10" value="1" />

		<label>Base64 image:</label>
		<textarea id="b64"></textarea>
		<button id="load">Load image</button>
		<button id="clear">Clear overlays</button>
		<button id="sample">Sample image</button>

		<p style="font-size:12px;color:#999;margin-top:12px">
			Move camera: W A S D or Arrow Keys<br>
			Right-click a tile to remove overlay.
		</p>
	</div>

	<div id="canvas-wrap"><canvas id="c"></canvas></div>

	<script>
// ==== CONFIG ====
const TILE_W = 64
const TILE_H = 32
const MAP_W = 12
const MAP_H = 12

// ==== DOM ====
const canvas = document.getElementById('c')
const ctx = canvas.getContext('2d')
const load = document.getElementById('load')
const b64 = document.getElementById('b64')
const clear = document.getElementById('clear')
const sample = document.getElementById('sample')

ctx.imageSmoothingEnabled = false

// ==== CAMERA ====
let camX = 0
let camY = 0
let zoom = 1

// ==== MAP ====
const terrains = ['grass', 'water', 'sand', 'stone']
const map = []
for (let y = 0; y < MAP_H; y++) {
	map[y] = []
	for (let x = 0; x < MAP_W; x++) {
		const r = Math.random()
		map[y][x] = r < .55 ? 'grass' : r < .75 ? 'water' : r < .9 ? 'sand' : 'stone'
	}
}

// overlays
const overlays = {}
let currentImage = null

// ==== CANVAS RESIZE ====
function resize() {
	const ratio = window.devicePixelRatio || 1
	const wrap = document.getElementById('canvas-wrap')
	const w = wrap.clientWidth
	const h = wrap.clientHeight
	canvas.style.width = w + 'px'
	canvas.style.height = h + 'px'
	canvas.width = w * ratio
	canvas.height = h * ratio
	ctx.setTransform(ratio, 0, 0, ratio, 0, 0)
	draw()
}
window.addEventListener('resize', resize)

// ==== ISOMETRIC MATH ====
function isoToScreen(i, j) {
	const x = (i - j) * (TILE_W / 2)
	const y = (i + j) * (TILE_H / 2)
	return { x, y }
}
function screenToIso(x, y) {
	x -= camX
	y -= camY
	x /= zoom
	y /= zoom
	const rx = x / (TILE_W / 2)
	const ry = y / (TILE_H / 2)
	const i = (ry + rx) / 2
	const j = (ry - rx) / 2
	return { i, j }
}

// ==== DRAW TILE ====
function drawTile(x, y, terrain, highlight) {
	ctx.save()
	ctx.translate(camX, camY)
	ctx.scale(zoom, zoom)
	ctx.beginPath()
	ctx.moveTo(x, y)
	ctx.lineTo(x + TILE_W / 2, y + TILE_H / 2)
	ctx.lineTo(x, y + TILE_H)
	ctx.lineTo(x - TILE_W / 2, y + TILE_H / 2)
	ctx.closePath()

	const g = ctx.createLinearGradient(x, y, x, y + TILE_H)
	if (terrain === 'grass') { g.addColorStop(0, '#6fc24b'); g.addColorStop(1, '#2b8a3a') }
	else if (terrain === 'water') { g.addColorStop(0, '#68c0ff'); g.addColorStop(1, '#0b6ab0') }
	else if (terrain === 'sand') { g.addColorStop(0, '#f7e3a1'); g.addColorStop(1, '#e6c06a') }
	else if (terrain === 'stone') { g.addColorStop(0, '#a18bd3'); g.addColorStop(1, '#6f4da3') }

	ctx.fillStyle = g
	ctx.fill()
	ctx.strokeStyle = 'rgba(0,0,0,.08)'; ctx.stroke()

	if (highlight) {
		ctx.fillStyle = 'rgba(255,255,255,.1)'
		ctx.fill()
		ctx.lineWidth = 2
		ctx.strokeStyle = 'rgba(255,255,255,.4)'; ctx.stroke()
	}
	ctx.restore()
}

// ==== DRAW OVERLAYS ====
function drawOverlays() {
	for (const k in overlays) {
		const [i, j] = k.split(',').map(Number)
		const pt = isoToScreen(i, j)
		const o = overlays[k]

		ctx.save()
		ctx.translate(camX, camY)
		ctx.scale(zoom, zoom)
		const w = o.w, h = o.h
		const dw = Math.min(TILE_W * 0.9, w)
		const sc = dw / w
		const dh = h * sc
		const dx = pt.x - dw / 2
		const dy = pt.y + TILE_H / 2 - dh
		ctx.drawImage(o.img, dx, dy, dw, dh)
		ctx.restore()
	}
}

let hover = null
function draw() {
	ctx.clearRect(0, 0, canvas.width, canvas.height)

	for (let j = 0; j < MAP_H; j++) {
		for (let i = 0; i < MAP_W; i++) {
			const pt = isoToScreen(i, j)
			drawTile(pt.x, pt.y, map[j][i], hover && hover.i === i && hover.j === j)
		}
	}
	drawOverlays()

	ctx.fillText(Math.round((1000.0 / (performance.now() - lastTime))), 10, 50)
	lastTime = performance.now()
}

// ==== POINTER ====
function getPos(e) {
	const r = canvas.getBoundingClientRect()
	const x = (e.clientX || e.touches[0].clientX) - r.left
	const y = (e.clientY || e.touches[0].clientY) - r.top
	return { x, y }
}

canvas.addEventListener('pointermove', (e) => {
	const p = getPos(e)
	const iso = screenToIso(p.x, p.y)
	const i = Math.floor(iso.i + 1e-6)
	const j = Math.floor(iso.j + 1e-6)
	hover = (i >= 0 && j >= 0 && i < MAP_W && j < MAP_H) ? { i, j } : null
	draw()
})

canvas.addEventListener('pointerdown', (e) => {
	const p = getPos(e)
	const iso = screenToIso(p.x, p.y)
	const i = Math.floor(iso.i + 1e-6)
	const j = Math.floor(iso.j + 1e-6)
	if (!(i >= 0 && j >= 0 && i < MAP_W && j < MAP_H)) return

	if (e.button === 2) { delete overlays[`${i},${j}`]; draw(); return }
	if (currentImage) { overlays[`${i},${j}`] = { img: currentImage, w: currentImage.width, h: currentImage.height }; draw() }
})
canvas.addEventListener('contextmenu', (e) => e.preventDefault())

// ==== BASE64 LOAD ====
function loadBase64(str) {
	if (!str) {
		alert('Paste base64 first')
		return
	}
	const img = new Image()
	img.onload = () => { currentImage = img; alert('Loaded.') }
	img.onerror = () => alert('Invalid base64')
	const t = str.trim()
	img.src = t.startsWith('data:') ? t : 'data:image/png;base64,' + t
}

load.onclick = () => loadBase64(b64.value)
clear.onclick = () => { for (const k in overlays) delete overlays[k]; draw() }
sample.onclick = () => {
	const s = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEEAAABACAYAAABFqxrgAAADoElEQVR4AeyYoa7UQBSGe2sIr4BFoHAoeBskr4AjwaJIUFgUCoMiQV2FICQECAQEguQaEhwK5iP5lmZ3u53ptNPt3iH9Mveenjnn//8UBG2z0J9HL2782WYhKU3xEDR+5epZs43vSofRllqoQY3v2+s7e/f1zFGbPQQNaTDGhL3ejbmT0zNbCBrQ0BiR3nXWmBkxdyYPQcEaiBEx1OMsZw/1p76fLAQFKjhVSEy/s90VcyemJzsEBSkwZmluj7vcnTtvdAgKUFCukDH33a2WMTO4kxyCCxXAkKVRi9pS9USH4AIXpi4q0a82tcbuHAzBgS6IHbxkn1rVPqSlNwQHOHBo0DG+V7te+jTuhOAFB/RdXFNdL3rb1r4JwQYvbDeewu9606ueWgs2+OKYz1xtetV7e+v6nQZyB6/xPr6hfXb/Y/PywZfm5rXb/1ijmVTNen1y723z8O75//9UIQiwIXXwGvr1hnlQ8+YfRgsEAV6wvuZTLxiHbS87IdhAEOAA62s61Y5x6NPeG4IXCAIcaP2YT7ViHIa0DobgAIIAF1g/plNtGIdYbdEhOJAgwIXWlzzVgnFI1ZIcggsIAhRgveTpbozD2N2jQ3AhQYCCrM95ugvjkLsrOwQFEAQo0PqUp7MxDlPNniwEBREEKNh6zuksjEPOrH13Jw/BJQQBGrCecnoX45ByN6V3thAUQRCgIeuHTnsxDod6p3g3ewiKJAjQoPXu6TuMQ/fdnD8XCaFrgCBAw90T49DtL/Fz8RA0RRBw/viiwTj4rvS5WAiljR7aV0MI6dQQagghgfDUL6GGEBIIT/0SagghgfDUL6GGEBIIT/0SagghgfDUL6GGEBIIz94vIdQv1dO++vSjef7u+6Uyrdk3Fz+br79+N+3nD9/OgCDAhlM+MQ/4hs1fB34BgoBTDAHjgE/Q4yYEC7wEggDraz4xDviCbS87IdhAMxAEWF/TiXHAB/Rp7w3BC1wGggDrx3xiHNANQ1oHQ3AAw4AgwPoxnRgHdEKstugQHMhwIAiwvuSJcUAXpGpJDsEFLAOCAOslT4wDOmDs7tEhuJDlQBBgfc4T48BeyN2VHYICEAMEAdanPDEO7IGpZk8WgoIQBwQB1nNOjANzIWfWvruTh+ASxAJBgPWUE+PAHEi5m9I7WwiKQDwQBFg/dGIcuAeHeqd4N3sIisQMEARY754YB/qg+27w54yGYiGoEXNAEPD09fsG40Ad7C11/gUAAP//oKU8SQAAAAZJREFUAwDknX3FayunJgAAAABJRU5ErkJggg=='
	b64.value = s
	loadBase64(b64.value)
}

// ==== CAMERA KEYS ====
const keys = {}
window.addEventListener('keydown', (e) => { keys[e.code] = true })
window.addEventListener('keyup', (e) => { keys[e.code] = false })

let lastTime = performance.now()
function camLoop() {
	let sp = 8
	if (keys['ArrowUp'] || keys['KeyW']) camY += sp
	if (keys['ArrowDown'] || keys['KeyS']) camY -= sp
	if (keys['ArrowLeft'] || keys['KeyA']) camX += sp
	if (keys['ArrowRight'] || keys['KeyD']) camX -= sp
	draw()
	requestAnimationFrame(camLoop)
}
camLoop()

// ==== ZOOM INPUT ====
document.getElementById('zoom').addEventListener('change', (e) => {
	zoom = Math.max(1, Number(e.target.value))
	ctx.imageSmoothingEnabled = false
	draw()
})

resize()
	</script>
</body>

</html>
